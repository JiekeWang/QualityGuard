# 简化断言配置指南 ⭐

## 核心理念

**维护成本最低，功能最实用！**

不需要写复杂的嵌套路径，只需要：
1. 简单的字段名
2. 关键内容片段

系统自动完成剩余工作！

---

## 快速上手

### 你的需求

验证响应中的 `PassedRules` 数组包含特定规则。

### 响应结构

```json
{
  "WorkflowName": "咬合重建-弹窗提醒",
  "ItemResultDict": {
    "OrthoDiagnosis": {
      "PassedRules": [
        {
          "RuleName": "5.符合弹窗提醒-III类骨性关系",
          "Output": "{\"Category\":\"侧位片\",\"Content\":\"III类骨性关系\"}"
        }
      ]
    }
  }
}
```

### 旧方式（复杂）❌

```excel
| expected_ItemResultDict_OrthoDiagnosis_PassedRules_0_RuleName | expected_ItemResultDict_OrthoDiagnosis_PassedRules_0_Output_contains |
|---------------------------------------------------------------|---------------------------------------------------------------------|
| 5.符合弹窗提醒-III类骨性关系 | III类骨性关系 |
```

**问题：**
- ❌ 列名太长，难以维护
- ❌ 需要了解完整的响应结构
- ❌ 数组索引写死，不灵活

### 新方式（简化）✅

```excel
| expected_PassedRules |
|---------------------|
| "RuleName": "5.符合弹窗提醒-III类骨性关系","Output": "{\"Category\":\"侧位片\",\"Content\":\"III类骨性关系 |
```

**优点：**
- ✅ 列名简洁：只需要字段名 `PassedRules`
- ✅ 内容片段：不需要写完整 JSON，只写关键部分
- ✅ 自动搜索：系统在响应中递归查找 `PassedRules`
- ✅ 智能匹配：自动处理数组、忽略格式差异

---

## 工作原理

### 1. 自动字段搜索

系统会在响应中**递归搜索** `PassedRules` 字段：

```
响应根 → ItemResultDict → OrthoDiagnosis → PassedRules ✅
```

找到后自动提取其值。

### 2. 智能内容匹配

系统会对字段值进行**智能匹配**：

#### 情况A：字段是数组

```json
"PassedRules": [
  {"RuleName": "规则1", "Output": "..."},
  {"RuleName": "规则2", "Output": "..."}
]
```

系统会检查**任一数组元素**是否匹配你的内容片段。

#### 情况B：字段是对象

```json
"PassedRules": {"RuleName": "规则1", "Output": "..."}
```

系统会将对象转为 JSON 字符串，检查是否**包含**你的内容片段。

#### 情况C：字段是字符串

```json
"PassedRules": "{\"RuleName\":\"规则1\"}"
```

系统直接进行**字符串包含**检查。

### 3. 格式容错

系统会自动忽略：
- 空格差异：`"a":1` vs `"a": 1`
- 换行差异：多行 vs 单行
- 字段顺序：`{"a":1,"b":2}` vs `{"b":2,"a":1}`

只要关键内容存在，断言就通过！

---

## Excel 配置示例

### 示例1：咬合重建规则引擎

| Codes | DamageToothCount | DamageAreaCount | expected_WorkflowName | expected_PassedRules |
|-------|------------------|----------------|----------------------|---------------------|
| CI-Il-bony | 1 | 1 | 咬合重建-弹窗提醒 | "RuleName": "4.符合弹窗提醒-II类骨性关系","Output": "{\"Category\":\"侧位片\",\"Content\":\"II类骨性关系 |
| CI-lll-bony | 2 | 1 | 咬合重建-弹窗提醒 | "RuleName": "5.符合弹窗提醒-III类骨性关系","Output": "{\"Category\":\"侧位片\",\"Content\":\"III类骨性关系 |

**说明：**
- 前3列：请求参数
- `expected_WorkflowName`：简单字段，精确匹配
- `expected_PassedRules`：复杂字段，智能匹配

### 示例2：用户信息验证

**响应：**
```json
{
  "data": {
    "user": {
      "profile": {
        "name": "张三",
        "age": 25,
        "email": "zhangsan@example.com"
      }
    }
  }
}
```

**Excel 配置：**

| expected_profile |
|-----------------|
| "name": "张三","age": 25 |

系统会：
1. 搜索并找到 `profile` 字段
2. 验证其中包含 `name` 和 `age` 字段
3. 不关心 `email` 字段（未在期望中）

---

## 何时使用简化配置

### ✅ 推荐场景

1. **字段在响应中唯一**
   - 如 `PassedRules`、`UserInfo` 等业务字段

2. **只需验证关键内容**
   - 不需要精确匹配完整 JSON
   - 容忍格式差异

3. **数组中任一匹配即可**
   - 不关心具体是第几个元素
   - 只要存在即可

4. **快速迭代阶段**
   - 接口结构可能变化
   - 需要降低维护成本

### ❌ 不推荐场景

1. **多个同名字段**
   - 响应中有多个 `data` 字段
   - 需要明确指定具体哪一个

2. **需要精确匹配**
   - 字段顺序必须一致
   - 不允许有额外字段

3. **数组特定元素**
   - 必须是第3个元素
   - 不能是其他元素

4. **需要不同操作符**
   - 某些字段用 `equal`
   - 某些字段用 `greater_than`

这些场景请使用**完整配置模式**。

---

## 常见问题

### Q1: 内容片段应该写多少？

**A:** 写足够唯一标识目标内容的关键字段即可。

```excel
# 最少 - 只写一个关键字段
| expected_PassedRules |
|---------------------|
| "RuleName": "规则1" |

# 中等 - 写2-3个关键字段（推荐）
| expected_PassedRules |
|---------------------|
| "RuleName": "规则1","Output": "内容1" |

# 最多 - 写所有字段（不推荐，失去简化优势）
| expected_PassedRules |
|---------------------|
| {"RuleName": "规则1","Output": "内容1","Status": "success"} |
```

### Q2: 如何处理 JSON 字符串字段？

**A:** 直接写字符串内容的关键部分。

```excel
| expected_Output |
|----------------|
| "Category":"侧位片","Content":"II类骨性关系" |
```

不需要处理转义，系统会自动处理。

### Q3: 如果字段没找到会怎样？

**A:** 断言失败，错误信息会提示 "字段 XXX 在响应中未找到"。

### Q4: 如果内容不匹配会怎样？

**A:** 断言失败，错误信息会显示：
- 期望包含的内容片段
- 实际找到的字段值（前200字符）

### Q5: 可以混合使用简化和完整配置吗？

**A:** 可以！同一个测试用例中：

```excel
| expected_status | expected_WorkflowName | expected_PassedRules_0_RuleName | expected_ErrorRules |
|----------------|----------------------|--------------------------------|---------------------|
| 200 | 咬合重建 | 规则1 | [] |
```

- `expected_status` - 特殊字段（HTTP 状态码）
- `expected_WorkflowName` - 完整配置（简单字段，精确匹配）
- `expected_PassedRules_0_RuleName` - 完整配置（带数组索引）
- `expected_ErrorRules` - 简化配置（智能匹配空数组）

---

## 调试技巧

### 1. 查看生成的断言类型

执行日志会显示：

```
== 断言配置检查 ==
断言配置详情:
  [1] {"type": "smart_match", "field": "PassedRules", "expected": "..."}
  [2] {"type": "json_path", "path": "$.WorkflowName", "expected": "..."}
```

- `smart_match` - 简化配置
- `json_path` - 完整配置

### 2. 逐步调试

**步骤1：** 先只配置简单字段

```excel
| expected_WorkflowName |
|----------------------|
| 咬合重建-弹窗提醒 |
```

**步骤2：** 成功后再添加复杂字段

```excel
| expected_WorkflowName | expected_PassedRules |
|----------------------|---------------------|
| 咬合重建-弹窗提醒 | "RuleName": "规则1" |
```

### 3. 查看实际响应

如果断言失败，复制执行日志中的"响应 Body"，用 JSON 格式化工具查看结构，确认：
1. 字段名是否正确
2. 内容片段是否存在

---

## 总结

### 🌟 核心优势

1. **维护成本最低** - 列名简洁，内容片段化
2. **容错性最强** - 忽略格式差异，自动处理数组
3. **学习成本最低** - 不需要了解 JSONPath 语法
4. **适应性最强** - 接口结构变化时影响最小

### 📝 使用建议

- ✅ **默认使用简化配置**
- ⚠️ **遇到问题再考虑完整配置**
- 🎯 **两种模式可以混合使用**

### 📖 延伸阅读

- [Excel 断言配置完整指南](./assertion-excel-format-guide.md) - 详细的配置说明
- [数据驱动测试使用指南](./data-driven-usage-guide.md) - 完整的测试流程
- [断言失败问题修复说明](./断言失败问题修复说明.md) - 常见问题排查

---

**立即开始使用简化配置，让数据驱动测试更简单！** 🚀

