# 数据库迁移执行说明

## 迁移脚本位置
`backend/migrations/create_test_data_config_tables.sql`

## 执行方式

### 方式1: 使用psql命令（推荐）

在服务器上执行：

```bash
cd /root/QualityGuard/backend

# 设置数据库连接信息（如果不在环境变量中）
export PGPASSWORD="qualityguard123"

# 执行迁移脚本
psql -h localhost -p 5432 -U qualityguard -d qualityguard -f migrations/create_test_data_config_tables.sql
```

### 方式2: 使用提供的Shell脚本

```bash
cd /root/QualityGuard/backend

# 设置执行权限
chmod +x scripts/run_migration_server.sh

# 执行迁移（会自动从环境变量读取连接信息）
./scripts/run_migration_server.sh
```

或者指定连接信息：

```bash
DB_HOST=localhost \
DB_PORT=5432 \
DB_NAME=qualityguard \
DB_USER=qualityguard \
DB_PASSWORD=qualityguard123 \
./scripts/run_migration_server.sh
```

### 方式3: 使用Python脚本

```bash
cd /root/QualityGuard/backend

# 确保已安装psycopg2-binary
pip install psycopg2-binary

# 执行迁移
python3 scripts/run_migration_server.py
```

或者指定连接信息：

```bash
DATABASE_URL="postgresql://qualityguard:qualityguard123@localhost:5432/qualityguard" \
python3 scripts/run_migration_server.py
```

## 验证迁移结果

执行以下SQL查询验证表是否创建成功：

```sql
-- 检查表是否存在
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
  AND table_name IN ('test_data_configs', 'test_case_test_data_configs');

-- 检查表结构
\d test_data_configs
\d test_case_test_data_configs

-- 检查索引
\di test_data_configs*
\di test_case_test_data_configs*
```

## 注意事项

1. **备份数据库**：在生产环境执行迁移前，建议先备份数据库
2. **权限检查**：确保数据库用户有CREATE TABLE和CREATE INDEX权限
3. **重复执行**：脚本使用了`CREATE TABLE IF NOT EXISTS`，可以安全地重复执行
4. **错误处理**：如果表已存在，会跳过创建，不会报错

## 回滚（如果需要）

如果需要回滚迁移，执行以下SQL：

```sql
-- 删除关联表（会自动级联删除关联关系）
DROP TABLE IF EXISTS test_case_test_data_configs CASCADE;

-- 删除主表
DROP TABLE IF EXISTS test_data_configs CASCADE;
```

