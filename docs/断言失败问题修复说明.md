# 断言失败问题修复说明

## 问题原因

你的测试用例断言失败，原因是：

### 1. JSONPath 路径错误 ❌

**错误配置：**
```json
{
  "path": "$.PassedRules"
}
```

**实际响应结构：**
```json
{
  "ItemResultDict": {
    "OrthoDiagnosis": {
      "PassedRules": [...]  ← 实际在这里，不是根级别
    }
  }
}
```

**正确路径应该是：**
```
$.ItemResultDict.OrthoDiagnosis.PassedRules[0].RuleName
```

### 2. Expected 值格式不合理 ❌

你的 expected 值是一个字符串片段，而不是有效的完整值。`PassedRules` 是一个数组，应该断言数组中的具体元素或字段。

---

## 修复方案

### ✅ 采用的方案：多字段分开断言（最可靠）

**为什么选择这个方案？**
- ✅ 兼容性最好 - 使用基础的 `json_path` 断言
- ✅ 错误定位精确 - 每个字段单独断言
- ✅ 灵活性强 - 支持不同的断言操作符
- ✅ 数据驱动友好 - Excel 中使用 `expected_` 前缀

---

## 如何正确配置

### Excel 数据格式（推荐）

| Codes | DamageToothCount | DamageAreaCount | expected_WorkflowName | expected_ItemResultDict_OrthoDiagnosis_PassedRules_0_RuleName | expected_ItemResultDict_OrthoDiagnosis_PassedRules_0_Output_contains |
|-------|------------------|----------------|----------------------|---------------------------------------------------------------|---------------------------------------------------------------------|
| CI-Il-bony | 1 | 1 | 咬合重建-弹窗提醒 | 4.符合弹窗提醒-II类骨性关系 | II类骨性关系 |
| CI-lll-bony | 2 | 1 | 咬合重建-弹窗提醒 | 5.符合弹窗提醒-III类骨性关系 | III类骨性关系 |
| DI-5-tooth | 5 | 3 | 咬合重建-弹窗提醒 | 6.符合弹窗提醒-5颗及以上缺牙 | 缺牙 |

**列名解释：**

1. **`Codes`, `DamageToothCount`, `DamageAreaCount`** - 请求参数，会替换到请求模板中

2. **`expected_WorkflowName`** - 断言 `$.WorkflowName` 字段

3. **`expected_ItemResultDict_OrthoDiagnosis_PassedRules_0_RuleName`**
   - 下划线自动转换为嵌套层级
   - 数字 `0` 表示数组第一个元素
   - 生成路径：`$.ItemResultDict.OrthoDiagnosis.PassedRules[0].RuleName`
   - 操作符：默认 `equal`（完全相等）

4. **`expected_ItemResultDict_OrthoDiagnosis_PassedRules_0_Output_contains`**
   - 路径：`$.ItemResultDict.OrthoDiagnosis.PassedRules[0].Output`
   - 操作符：`_contains` 后缀表示包含检查（更可靠，不受 JSON 格式影响）

---

## 系统增强

### 1. 增强的路径推断

支持任意深度的嵌套路径：

| Excel 列名 | 生成的 JSONPath |
|-----------|----------------|
| `expected_user_id` | `$.data.user_id` |
| `expected_items_0_name` | `$.items[0].name` |
| `expected_a_b_c_0_d` | `$.a.b.c[0].d` |
| `expected_ItemResultDict_OrthoDiagnosis_PassedRules_0_RuleName` | `$.ItemResultDict.OrthoDiagnosis.PassedRules[0].RuleName` |

### 2. 支持的操作符

| 后缀 | 操作符 | 说明 |
|------|--------|------|
| （无后缀） | `equal` | 完全相等（默认） |
| `_contains` | `contains` | 包含（推荐用于长字符串、JSON 字符串） |
| `_greater_than` | `greater_than` | 大于 |
| `_less_than` | `less_than` | 小于 |
| `_not_equal` | `not_equal` | 不等于 |
| `_exists` | `exists` | 字段存在 |

### 3. 自动类型转换

- 数字自动识别：`"123"` → `123`
- 布尔值识别：`"true"` → `true`
- null 识别：`"null"` → `null`

---

## 快速开始

### 步骤 1：下载示例 CSV 文件

文件已创建：`docs/咬合重建测试数据示例.csv`

### 步骤 2：导入到测试用例

1. 打开你的测试用例："【咬合重建规则引擎】弹框提醒验证"
2. 切换到"数据驱动配置"Tab
3. 点击"导入 CSV/Excel"按钮
4. 选择示例 CSV 文件
5. 点击"保存"

### 步骤 3：执行测试

1. 点击"执行测试"按钮
2. 查看执行日志，确认断言配置正确：

```
== 断言配置检查 ==
使用测试数据中的断言配置，数量: 3
断言配置详情:
  [1] {"type": "json_path", "path": "$.WorkflowName", "operator": "equal", "expected": "咬合重建-弹窗提醒"}
  [2] {"type": "json_path", "path": "$.ItemResultDict.OrthoDiagnosis.PassedRules[0].RuleName", "operator": "equal", "expected": "4.符合弹窗提醒-II类骨性关系"}
  [3] {"type": "json_path", "path": "$.ItemResultDict.OrthoDiagnosis.PassedRules[0].Output", "operator": "contains", "expected": "II类骨性关系"}
```

3. 查看断言执行结果，应该全部通过 ✅

---

## 详细文档

- 📖 [Excel 断言配置完整指南](./assertion-excel-format-guide.md) - 详细的断言配置说明
- 📖 [数据驱动测试使用指南](./data-driven-usage-guide.md) - 完整的数据驱动测试流程

---

## 常见问题

### Q: 为什么使用 `_contains` 而不是精确匹配？

**A:** `Output` 字段是一个 JSON 字符串，例如：
```json
"{\"Category\":\"侧位片\",\"Content\":\"II类骨性关系\"}"
```

精确匹配容易因为以下原因失败：
- JSON 字段顺序不同
- 空格数量不同
- 转义字符处理不同

使用 `_contains` 只验证关键内容存在，更可靠。

### Q: 如果我需要精确匹配怎么办？

**A:** 去掉 `_contains` 后缀：

```excel
| expected_ItemResultDict_OrthoDiagnosis_PassedRules_0_Output |
|-------------------------------------------------------------|
| {"Category":"侧位片","Content":"II类骨性关系"} |
```

注意：JSON 格式必须完全一致。

### Q: 如何断言数组长度？

**A:** 断言多个数组元素：

```excel
| expected_PassedRules_0_RuleName | expected_PassedRules_1_RuleName |
|--------------------------------|--------------------------------|
| 规则1                           | 规则2                           |
```

这会确保数组至少有 2 个元素。

---

## 总结

✅ **问题已修复**：增强了断言生成逻辑，支持深层嵌套路径和多种操作符

✅ **示例已创建**：`docs/咬合重建测试数据示例.csv` 可直接使用

✅ **文档已完善**：详细的配置指南和最佳实践

✅ **服务已部署**：后端服务已重启，修复立即生效

---

## 立即测试 🚀

1. 导入示例 CSV 文件到你的测试用例
2. 执行测试
3. 查看断言是否全部通过

如有问题，请参考详细文档或查看执行日志。

