# 数据驱动配置迁移方案 - 实施细节

## 一、需求确认

根据用户需求，需要实现：

1. **在数据驱动配置菜单中**：
   - 沿用测试用例-编辑测试用例-数据驱动配置-测试数据列表的导入CSV/Excel生成接口入参和断言逻辑
   - 支持数据导入（CSV/Excel）
   - 新增的每行数据代表一个接口的所有入参、断言数据
   - 行数据支持编辑，点击编辑可维护导入的接口入参和断言数据
   - 可选择与哪个测试用例关联

## 二、技术实现要点

### 2.1 复用现有组件

**DataDriverTable组件**已经实现了：
- CSV/Excel导入功能
- 数据列表展示（表格形式）
- 行数据的添加/删除
- 行数据的编辑（直接在表格中编辑JSON）

**需要调整**：
- 将组件改造为可以独立使用（不依赖form）
- 支持外部数据源（从API加载）
- 行编辑改为Modal弹窗形式，支持关联测试用例

### 2.2 数据模型设计

**TestDataConfig表结构**：
```sql
CREATE TABLE test_data_configs (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    project_id INTEGER REFERENCES projects(id),
    data JSONB NOT NULL DEFAULT '[]',  -- 测试数据数组
    is_active BOOLEAN DEFAULT TRUE,
    created_by INTEGER REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE
);
```

**TestCaseTestDataConfig关联表**：
```sql
CREATE TABLE test_case_test_data_configs (
    id SERIAL PRIMARY KEY,
    test_case_id INTEGER NOT NULL REFERENCES test_cases(id) ON DELETE CASCADE,
    test_data_config_id INTEGER NOT NULL REFERENCES test_data_configs(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(test_case_id, test_data_config_id)
);
```

### 2.3 API设计

#### 测试数据配置API

```python
# GET /api/v1/test-data-configs
# 参数：project_id, search, skip, limit
# 返回：配置列表

# POST /api/v1/test-data-configs
# Body: {
#   "name": "配置名称",
#   "description": "描述",
#   "project_id": 1,
#   "data": [...]
# }

# GET /api/v1/test-data-configs/{id}
# 返回：配置详情

# PUT /api/v1/test-data-configs/{id}
# Body: 同POST

# DELETE /api/v1/test-data-configs/{id}
# 检查是否有用例关联，如有则提示

# GET /api/v1/test-data-configs/{id}/usage
# 返回：关联的用例列表
```

#### 关联管理API

```python
# POST /api/v1/test-cases/{case_id}/test-data-configs
# Body: {"test_data_config_id": 1}

# DELETE /api/v1/test-cases/{case_id}/test-data-configs/{config_id}

# GET /api/v1/test-cases/{case_id}/test-data-configs
# 返回：关联的配置列表
```

### 2.4 前端实现细节

#### 1. 数据驱动配置页面 - "测试数据"Tab

**页面结构**：
```
数据驱动配置页面
├── Tabs
│   ├── 数据源
│   ├── 数据模板
│   ├── 数据生成器
│   └── 测试数据（新增）
│       ├── 配置列表表格
│       ├── 创建/编辑配置Modal
│       │   └── TestDataConfigForm
│       │       ├── 基本信息（名称、描述、项目）
│       │       └── TestDataTable组件（复用DataDriverTable逻辑）
│       └── 行数据编辑Modal
│           ├── Request编辑器
│           ├── Assertions编辑器
│           └── 关联用例选择器
```

#### 2. TestDataTable组件（改造自DataDriverTable）

**Props接口**：
```typescript
interface TestDataTableProps {
  value: Array<{
    request: any;
    assertions: any[];
  }>;
  onChange: (data: Array<{request: any; assertions: any[]}>) => void;
  onRowEdit?: (index: number, rowData: any) => void;  // 行编辑回调
}
```

**功能**：
- 复用CSV/Excel导入逻辑
- 支持添加/删除行
- 表格展示（只读模式，点击编辑按钮打开Modal）
- 导出JSON

#### 3. 行数据编辑Modal

**组件结构**：
```typescript
interface RowEditModalProps {
  visible: boolean;
  rowData: {request: any; assertions: any[]};
  rowIndex: number;
  testCaseOptions: Array<{id: number; name: string}>;  // 可选关联的用例
  associatedCases: number[];  // 已关联的用例ID列表
  onSave: (data: any, associatedCases: number[]) => void;
  onCancel: () => void;
}
```

**功能**：
- Request JSON编辑器（Monaco Editor或TextArea）
- Assertions JSON数组编辑器
- 测试用例多选（关联用例）
- 保存/取消按钮

#### 4. 配置列表表格

**列定义**：
- 配置名称（可点击查看详情）
- 项目
- 数据行数（显示data数组长度）
- 关联用例数（通过关联表统计）
- 创建时间
- 操作（编辑、删除、查看详情）

### 2.5 执行引擎集成

**修改位置**：`backend/app/api/v1/test_executions.py`

**修改逻辑**：
```python
# 在 create_test_execution 函数中

# 1. 加载关联的测试数据配置
test_data_list = []
if test_case.test_data_config_relations:
    for relation in test_case.test_data_config_relations:
        config = relation.test_data_config
        if config.is_active and config.data:
            test_data_list.extend(config.data)

# 2. 向后兼容：加载旧的data_driver
if test_case.data_driver and isinstance(test_case.data_driver, dict):
    old_data = test_case.data_driver.get('data', [])
    if old_data:
        test_data_list.extend(old_data)

# 3. 判断是否为数据驱动
is_data_driven = len(test_data_list) > 0
```

## 三、实施步骤

### Step 1: 后端模型和API（1-2天）

1. 创建模型文件 `backend/app/models/test_data_config.py`
2. 创建Schema文件 `backend/app/schemas/test_data_config.py`
3. 创建API文件 `backend/app/api/v1/test_data_configs.py`
4. 创建关联API（在test_cases.py中或新建）
5. 数据库迁移脚本
6. 注册路由

### Step 2: 前端服务和组件（2-3天）

1. 创建服务文件 `frontend/src/store/services/testDataConfig.ts`
2. 改造DataDriverTable为TestDataTable组件
3. 创建RowEditModal组件
4. 在DataDrivers.tsx中添加"测试数据"Tab
5. 实现配置列表、创建、编辑、删除功能
6. 实现行数据编辑和关联用例功能

### Step 3: 执行引擎支持（1天）

1. 修改test_executions.py加载关联配置
2. 合并数据源逻辑
3. 测试执行流程

### Step 4: 测试和优化（1-2天）

1. 功能测试
2. 边界情况测试
3. 性能优化
4. UI/UX优化

## 四、注意事项

1. **数据格式一致性**：确保导入的CSV/Excel转换为的数据格式与现有格式一致
2. **关联管理**：删除配置前检查关联，删除用例时不影响配置
3. **权限控制**：配置的查看/编辑权限应与项目权限关联
4. **性能考虑**：大量数据时的加载和渲染优化
5. **向后兼容**：确保旧的data_driver字段继续工作

