# 接口关联与变量提取指南

## 功能概述

当您需要从一个接口的响应中提取数据（如 token），并在后续请求中使用时，可以使用**变量提取（Extractors）**功能。

## 使用场景

### 场景1：获取 Token 并用于后续请求

1. 调用登录接口获取 token
2. 将 token 用于业务接口的 Authorization 请求头

### 场景2：关联数据提取

1. 创建用户后获取 user_id
2. 使用 user_id 查询用户详情
3. 使用 user_id 更新用户信息

## 配置方法

### 步骤1：配置请求

在"请求配置" Tab 中，填写第一个请求的配置（例如获取 token 的接口）：

```json
{
  "headers": {
    "Content-Type": "application/json"
  },
  "body": {
    "username": "admin",
    "password": "123456"
  }
}
```

### 步骤2：配置变量提取

在"关联提取" Tab 中，配置要提取的变量：

```json
[
  {
    "name": "token",
    "type": "json",
    "path": "$.data.token"
  },
  {
    "name": "userId",
    "type": "json",
    "path": "$.data.user.id"
  }
]
```

**配置说明：**

- `name`: 变量名称，后续可以通过 `${name}` 引用
- `type`: 提取类型，支持：
  - `json`: 从 JSON 响应中提取（最常用）
  - `regex`: 使用正则表达式从响应文本中提取
- `path`: JSONPath 表达式，用于定位要提取的数据

### 步骤3：在数据驱动中使用变量

在"数据驱动配置" Tab 中，可以在请求参数中引用提取的变量：

#### CSV 示例：

| request_Codes | request_headers |
|--------------|-----------------|
| CI-Il-bony   | {"Authorization": "Bearer ${token}"} |
| CI-Ill-bony  | {"Authorization": "Bearer ${token}"} |

#### 表格中直接编辑：

**接口入参：**
```json
{
  "headers": {
    "Authorization": "Bearer ${token}"
  },
  "body": {
    "userId": "${userId}",
    "action": "query"
  }
}
```

## JSONPath 语法示例

### 基本路径

| JSONPath | 说明 | 响应示例 | 提取结果 |
|----------|------|----------|----------|
| `$.data.token` | 提取 data 下的 token | `{"data": {"token": "abc123"}}` | `"abc123"` |
| `$.user.id` | 提取 user 下的 id | `{"user": {"id": 1001}}` | `1001` |
| `$.items[0].name` | 提取数组第一个元素的 name | `{"items": [{"name": "item1"}]}` | `"item1"` |

### 嵌套路径

```json
{
  "data": {
    "user": {
      "profile": {
        "email": "test@example.com"
      }
    }
  }
}
```

使用 `$.data.user.profile.email` 可以提取 `"test@example.com"`

### 数组索引

```json
{
  "items": [
    {"id": 1, "name": "item1"},
    {"id": 2, "name": "item2"}
  ]
}
```

- `$.items[0].id` → `1`
- `$.items[1].name` → `"item2"`

## 正则表达式提取

如果响应是纯文本而不是 JSON，可以使用正则表达式提取：

```json
[
  {
    "name": "sessionId",
    "type": "regex",
    "pattern": "session_id=(\\w+)"
  }
]
```

**注意：** 
- 正则表达式需要包含捕获组 `()`
- 系统会提取第一个捕获组的内容
- 如果没有捕获组，会提取整个匹配结果

## 完整示例

### 示例1：Token 认证流程

**测试用例配置：**

1. **基本信息** Tab：
   - 名称：Token 认证测试
   - 描述：测试 token 获取和使用

2. **请求配置** Tab：
```json
{
  "method": "POST",
  "path": "/api/auth/login",
  "headers": {
    "Content-Type": "application/json"
  },
  "body": {
    "username": "admin",
    "password": "123456"
  }
}
```

3. **关联提取** Tab：
```json
[
  {
    "name": "token",
    "type": "json",
    "path": "$.data.token"
  }
]
```

4. **数据驱动配置** Tab：

在 CSV 中配置多个业务请求，都使用提取的 token：

| request_path | request_method | request_headers |
|-------------|----------------|-----------------|
| /api/users  | GET            | {"Authorization": "Bearer ${token}"} |
| /api/orders | GET            | {"Authorization": "Bearer ${token}"} |
| /api/profile | GET           | {"Authorization": "Bearer ${token}"} |

### 示例2：用户创建和查询

**CSV 数据：**

| request_name | request_email | expected_status |
|--------------|---------------|-----------------|
| User1        | user1@test.com | 201            |
| User2        | user2@test.com | 201            |

**关联提取配置：**
```json
[
  {
    "name": "createdUserId",
    "type": "json",
    "path": "$.data.id"
  }
]
```

这样，创建用户后，系统会自动提取返回的 user id，后续请求可以使用 `${createdUserId}`。

## 执行日志示例

当变量提取成功时，测试日志中会显示：

```
== 变量提取 ==
✓ 提取变量 'token' = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
✓ 提取变量 'userId' = 1001
```

如果提取失败，会显示：

```
== 变量提取 ==
✗ 提取变量 'token' 失败：未找到匹配的数据
```

## 注意事项

1. **变量作用域**：提取的变量在整个测试执行过程中有效，可以在后续的所有数据驱动迭代中使用

2. **变量优先级**：如果数据驱动配置中有同名字段，会覆盖提取的变量

3. **JSONPath 限制**：当前实现支持基本的 JSONPath 语法（如 `$.a.b[0].c`），不支持复杂的过滤器和函数

4. **提取时机**：变量提取发生在第一次请求之后，因此第一次请求中无法使用提取的变量，但后续的数据驱动迭代可以使用

5. **错误处理**：如果提取失败（路径不存在），变量不会被创建，使用时保持 `${变量名}` 原样

## 最佳实践

1. **命名规范**：变量名使用驼峰命名法，如 `accessToken`、`userId`

2. **路径验证**：先在响应数据中确认路径的正确性，再配置提取器

3. **日志检查**：执行后查看日志中的"变量提取"部分，确认变量是否成功提取

4. **测试隔离**：如果多个数据驱动迭代需要不同的 token，建议为每次迭代配置独立的登录请求

5. **文档化**：在测试用例的描述中说明提取了哪些变量，方便团队协作

## 故障排查

### 问题1：提取的变量未生效

**可能原因：**
- JSONPath 路径错误
- 响应数据结构与预期不符
- 变量名拼写错误

**解决方法：**
1. 查看测试日志中的"变量提取"部分
2. 检查实际的响应数据结构
3. 使用浏览器控制台测试 JSONPath 表达式

### 问题2：变量值为 None

**可能原因：**
- 响应不是 JSON 格式
- JSONPath 路径不存在

**解决方法：**
1. 确认响应的 Content-Type
2. 手动检查响应数据，确认路径是否正确

### 问题3：正则提取失败

**可能原因：**
- 正则表达式语法错误
- 没有使用捕获组
- 响应文本格式不匹配

**解决方法：**
1. 使用在线正则工具测试表达式
2. 确保使用了捕获组 `()`
3. 检查实际的响应文本内容

## 高级用法

### 提取多个变量

```json
[
  {
    "name": "token",
    "type": "json",
    "path": "$.data.token"
  },
  {
    "name": "refreshToken",
    "type": "json",
    "path": "$.data.refreshToken"
  },
  {
    "name": "userId",
    "type": "json",
    "path": "$.data.user.id"
  },
  {
    "name": "username",
    "type": "json",
    "path": "$.data.user.name"
  }
]
```

### 提取数组中的元素

```json
[
  {
    "name": "firstItemId",
    "type": "json",
    "path": "$.data.items[0].id"
  },
  {
    "name": "lastItemId",
    "type": "json",
    "path": "$.data.items[-1].id"
  }
]
```

**注意：** 当前实现可能不支持 `[-1]` 语法，建议使用具体索引。

### 组合使用

在请求中同时使用提取的变量和数据驱动的数据：

```json
{
  "headers": {
    "Authorization": "Bearer ${token}",
    "User-Agent": "TestClient/1.0"
  },
  "body": {
    "userId": "${userId}",
    "action": "${action}",
    "data": {
      "field1": "${field1}",
      "field2": "${field2}"
    }
  }
}
```

其中 `token` 和 `userId` 来自变量提取，`action`、`field1`、`field2` 来自数据驱动配置。

## 总结

变量提取功能使您能够：
- ✅ 轻松实现接口间的数据关联
- ✅ 自动化 token 管理
- ✅ 支持复杂的测试场景
- ✅ 减少手动维护成本

现在您可以开始使用这个功能了！如有问题，请查看执行日志或联系技术支持。

