# 数据驱动配置迁移方案

## 一、现状分析

### 1. 当前实现

**测试用例模型（TestCase）**
- `is_data_driven`: Boolean - 是否为数据驱动用例
- `data_driver`: JSON - 数据驱动配置，包含：
  ```json
  {
    "data": [
      {
        "request": {},      // 接口入参
        "assertions": []    // 断言配置
      }
    ]
  }
  ```

**现有功能**
- `DataDriverTable` 组件：支持导入CSV/Excel生成接口入参和断言
- CSV/Excel导入逻辑：自动识别 `expected_*` 字段生成断言，其他字段作为请求参数
- 每行数据代表一个测试场景（包含完整的请求和断言配置）

**已存在的独立模块**
- `DataSource` (数据源) - 已有独立模型和API
- `DataTemplate` (数据模板) - 已有独立模型和API，关联到数据源
- `DataGenerator` (数据生成器) - 已有独立模型和API

**问题**
1. 数据驱动配置分散在测试用例中，难以统一管理
2. 多个测试用例使用相同配置时需要重复维护
3. 无法在"数据驱动配置"模块中统一查看和管理所有配置
4. 测试执行时从 `test_case.data_driver` 读取，不支持引用独立配置

---

## 二、设计方案（简化版）

### 方案：创建独立的"测试数据配置"实体

**核心思路**：
1. 创建 `TestDataConfig` 模型（测试数据配置实体），存储多行测试数据
2. 每行数据包含：`request`（接口入参）和 `assertions`（断言配置）
3. 测试用例通过 `test_data_config_id` 引用配置
4. 在数据驱动配置页面新增"测试数据"Tab，统一管理所有配置
5. 支持CSV/Excel导入、行数据编辑、关联测试用例

### 2.1 数据模型设计

#### 新增模型：TestDataConfig

```python
class TestDataConfig(Base):
    """测试数据配置模型"""
    __tablename__ = "test_data_configs"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(200), nullable=False, index=True)  # 配置名称
    description = Column(Text)  # 描述
    project_id = Column(Integer, ForeignKey("projects.id"), nullable=True)  # 项目ID
    
    # 测试数据列表，每行包含 request 和 assertions
    # 格式: [{"request": {...}, "assertions": [...]}, ...]
    data = Column(JSON, nullable=False, default=list)  # 测试数据数组
    
    # 元数据
    is_active = Column(Boolean, default=True)  # 是否激活
    created_by = Column(Integer, ForeignKey("users.id"), nullable=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
    
    # 关系
    project = relationship("Project", backref="test_data_configs")
    creator = relationship("User", foreign_keys=[created_by], backref="created_test_data_configs")
```

**数据格式说明**：
```json
{
  "data": [
    {
      "request": {
        "Codes": "R-lower",
        "DamageToothCount": 1,
        "DamageAreaCount": 2
      },
      "assertions": [
        {
          "type": "smart_match",
          "field": "PassedRules",
          "expected": "..."
        }
      ]
    }
  ]
}
```

#### 新增关联表：TestCaseTestDataConfig（多对多关系）

```python
class TestCaseTestDataConfig(Base):
    """测试用例与测试数据配置的关联表（支持多对多）"""
    __tablename__ = "test_case_test_data_configs"
    
    id = Column(Integer, primary_key=True, index=True)
    test_case_id = Column(Integer, ForeignKey("test_cases.id"), nullable=False)
    test_data_config_id = Column(Integer, ForeignKey("test_data_configs.id"), nullable=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    
    # 关系
    test_case = relationship("TestCase", backref="test_data_config_relations")
    test_data_config = relationship("TestDataConfig", backref="test_case_relations")
    
    # 唯一约束：一个用例可以关联多个配置，但不能重复关联
    __table_args__ = (
        UniqueConstraint('test_case_id', 'test_data_config_id', name='uq_test_case_config'),
    )
```

**说明**：支持多对多关系，一个测试数据配置可以被多个用例使用，一个用例也可以关联多个配置（场景：不同环境使用不同数据）

#### 修改模型：TestCase（可选，向后兼容）

```python
class TestCase(Base):
    # ... 现有字段 ...
    
    # 保留现有字段（向后兼容）
    data_driver = Column(JSON)  # 保留用于向后兼容
    is_data_driven = Column(Boolean, default=False)  # 保持兼容
```

**字段说明**：
- `is_data_driven`: 如果有关联的测试数据配置或 `data_driver` 不为空，则为 `True`
- `data_driver`: 保留用于向后兼容，新功能使用关联表

---

### 2.2 API设计

#### 测试数据配置管理API

**路径**: `/api/v1/test-data-configs`

**接口列表**：
1. `GET /test-data-configs` - 获取配置列表（支持项目筛选、搜索）
2. `POST /test-data-configs` - 创建配置
3. `GET /test-data-configs/{id}` - 获取配置详情
4. `PUT /test-data-configs/{id}` - 更新配置
5. `DELETE /test-data-configs/{id}` - 删除配置（检查是否有用例引用）
6. `GET /test-data-configs/{id}/usage` - 获取配置使用情况（哪些用例在使用）

**请求/响应示例**：
```python
# POST /test-data-configs
{
  "name": "咬合重建测试数据",
  "description": "咬合重建规则的测试数据",
  "project_id": 1,
  "data": [
    {
      "request": {"Codes": "R-lower", "DamageToothCount": 1},
      "assertions": [{"type": "smart_match", "field": "PassedRules", "expected": "..."}]
    }
  ]
}
```

#### 测试用例关联API

**路径**: `/api/v1/test-cases/{case_id}/test-data-configs`

**接口列表**：
1. `POST /test-cases/{case_id}/test-data-configs` - 关联测试数据配置
   ```json
   {
     "test_data_config_id": 1
   }
   ```
2. `DELETE /test-cases/{case_id}/test-data-configs/{config_id}` - 取消关联
3. `GET /test-cases/{case_id}/test-data-configs` - 获取用例关联的所有配置

#### 测试用例API调整（向后兼容）

**修改**: `PUT /test-cases/{id}` 和 `POST /test-cases`
- 保持对 `data_driver` 字段的支持（向后兼容）
- 支持通过关联API关联测试数据配置

**新增**: `GET /test-cases/{id}/data-preview` - 预览数据（包括关联的配置和旧的data_driver）

---

### 2.3 前端设计

#### 数据驱动配置页面（DataDrivers.tsx）

**新增Tab**: "测试数据"

功能：
1. **配置列表展示（表格）**
   - 配置名称
   - 项目
   - 数据行数
   - 关联用例数
   - 创建时间
   - 操作（编辑、删除、查看详情）

2. **创建/编辑配置表单**
   - 配置名称（必填）
   - 描述
   - 项目（可选）
   - **测试数据列表**（复用 `DataDriverTable` 组件）
     - 支持导入CSV/Excel
     - 支持添加/删除/编辑行
     - 每行包含：接口入参（request）和断言（assertions）
     - 支持导出JSON

3. **行数据编辑（Modal）**
   - 点击表格中的"编辑"按钮打开
   - 编辑该行的 request（JSON编辑器）
   - 编辑该行的 assertions（JSON数组编辑器）
   - 显示该行关联的测试用例列表
   - 可以选择/取消关联测试用例

4. **配置详情查看**
   - 显示配置基本信息
   - 显示测试数据列表（表格形式）
   - 显示关联的用例列表
   - 支持快速编辑和删除

5. **关联用例管理**
   - 在编辑配置页面，可以查看关联的用例
   - 可以添加/移除关联
   - 显示用例名称、项目等信息

#### 测试用例页面（TestCases.tsx）

**修改**：
1. 编辑表单中，数据驱动部分：
   - 显示"关联的测试数据配置"列表（支持多选）
   - 可以添加/移除关联
   - 提供"在数据驱动配置页面新建"快捷入口
   - 保留旧的 `data_driver` 编辑功能（向后兼容）

**向后兼容**：
- 如果用例使用旧的 `data_driver`，仍然可以编辑
- 可以同时使用关联配置和旧的 `data_driver`
- 执行时会合并所有数据源

---

### 2.4 测试执行逻辑调整

**执行流程**：
1. 收集所有数据源：
   - 从 `TestCaseTestDataConfig` 关联表加载所有关联的 `TestDataConfig`
   - 合并所有配置中的 `data` 数组
   - 如果 `test_case.data_driver` 存在，也加入数据源
   
2. 合并数据：
   ```python
   all_test_data = []
   # 从关联的配置加载
   for config in test_case.test_data_config_relations:
       all_test_data.extend(config.test_data_config.data)
   # 从旧的 data_driver 加载（向后兼容）
   if test_case.data_driver and test_case.data_driver.get('data'):
       all_test_data.extend(test_case.data_driver['data'])
   ```

3. 去重（可选，根据实际需求）
4. 按照数据顺序执行，每行数据代表一个测试场景
5. 如果 `all_test_data` 为空，按照非数据驱动模式执行

---

## 三、迁移步骤

### 阶段1：创建新模型和API（不破坏现有功能）
1. 创建 `TestDataConfig` 模型
2. 创建 `TestCaseTestDataConfig` 关联表模型
3. 数据库迁移（添加新表）
4. 创建测试数据配置管理API
5. 创建测试用例关联API
6. 前端添加"测试数据"Tab（基础功能）
7. 测试新功能

### 阶段2：前端集成
1. 数据驱动配置页面"测试数据"Tab完整功能
   - 复用 `DataDriverTable` 组件
   - 支持CSV/Excel导入
   - 支持行数据编辑（Modal弹窗）
   - 支持关联测试用例（在行编辑中）
2. 测试用例页面支持关联配置
3. 支持创建/编辑/删除配置

### 阶段3：执行引擎支持
1. 修改测试执行逻辑，支持从关联表加载数据
2. 合并多个配置的数据源
3. 向后兼容旧的 `data_driver` 字段

### 阶段4：迁移工具（可选）
1. 创建迁移脚本，将旧的 `data_driver` 数据转换为 `DataDriverConfig`
2. 批量迁移现有用例
3. 提供手动迁移界面

### 阶段5：清理（未来）
1. 废弃 `data_driver` 字段
2. 统一使用 `data_driver_config_id`

---

## 四、优势

1. **统一管理**：所有数据驱动配置在独立模块中统一管理
2. **复用性强**：一个配置可以被多个用例使用
3. **易于维护**：修改配置后，所有使用该配置的用例自动生效
4. **向后兼容**：保留旧字段，不影响现有用例
5. **扩展性好**：未来可以添加配置版本、配置共享等功能

---

## 五、注意事项

1. **数据一致性**：删除配置前需要检查是否有用例在使用
2. **权限控制**：配置的查看/编辑权限需要与项目权限关联
3. **性能优化**：数据源/模板的数据加载需要做缓存
4. **错误处理**：配置引用的数据源/模板被删除时的处理

---

## 六、实施建议

1. **优先级**：高 - 提升用户体验和系统可维护性
2. **工作量评估**：
   - 后端模型和API：1-2天
   - 前端"测试数据"Tab和组件复用：2-3天
   - 执行引擎支持：1天
   - 测试和修复：1-2天
   - 总计：5-8天
3. **风险**：低 - 向后兼容，不影响现有功能，复用现有组件

---

## 七、后续扩展

1. **配置版本管理**：记录配置的历史版本
2. **配置模板**：预定义的常用配置模板
3. **配置分享**：跨项目分享配置
4. **配置导入导出**：支持配置的批量导入导出

